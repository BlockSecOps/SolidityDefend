# v1.10.20 Baseline — Contract Attribution & AA Classification Fix (v12)

**Date**: 2026-02-12
**Total Findings**: 1,089 across 18 test targets (unchanged from v11)
**Clean Contract FPs**: 3 across 5 clean contracts (pre-existing; not introduced by v12 changes)
**Tests Passing**: 1,595 (1,392 detector + 32 FP regression + 17 front-running + misc)
**TP Regressions**: 0 (78/78 TPs detected, 100% recall)
**Parse Errors**: 0 (all 117 contracts parse successfully)

## Severity Breakdown

| Severity | Count |
|----------|-------|
| Critical | 300 |
| High | 540 |
| Medium | 184 |
| Low | 51 |
| Info | 14 |
| **Total** | **1,089** |

## Per-Target Findings

| # | Target | v11 Findings | v12 Findings | Change |
|---|--------|-------------|-------------|--------|
| 1 | `clean_examples/clean_contract.sol` | 0 | 0 | 0 |
| 2 | `fp_benchmarks/safe_amm_pool.sol` | 2 | 2 | 0 |
| 3 | `fp_benchmarks/safe_chainlink_consumer.sol` | 0 | 0 | 0 |
| 4 | `fp_benchmarks/safe_erc4626_vault.sol` | 0 | 0 | 0 |
| 5 | `fp_benchmarks/safe_flash_loan_provider.sol` | 1 | 1 | 0 |
| 6 | `basic_vulnerabilities/reentrancy_issues.sol` | 2 | 2 | 0 |
| 7 | `basic_vulnerabilities/validation_issues.sol` | 3 | 3 | 0 |
| 8 | `vulnerable/` | 51 | 51 | 0 |
| 9 | `flash_loans/` | 23 | 23 | 0 |
| 10 | `erc4626_vaults/` | 43 | 43 | 0 |
| 11 | `price-manipulation/` | 135 | 135 | 0 |
| 12 | `cross_chain/` | 42 | 42 | 0 |
| 13 | `delegatecall/` | 372 | 372 | 0 |
| 14 | `signatures/` | 194 | 194 | 0 |
| 15 | `specialized/` | 69 | 69 | 0 |
| 16 | `restaking/` | 95 | 95 | 0 |
| 17 | `account_abstraction/` | 16 | 16 | 0 |
| 18 | `amm_context/` | 41 | 41 | 0 |
| | **TOTAL** | **1,089** | **1,089** | **0** |

## v12 Changes: Contract Attribution & AA Classification Fix

### Problem Statement

When scanning multi-contract Solidity files (e.g., `VulnerableEntryPointTrust.sol` containing 3 contracts + 1 interface), two issues were observed:

1. **Missing `contract_name` in JSON output** — SolidityDefend findings had no contract attribution. The BlockSecOps platform received 68 findings with empty `contract_name`, while Slither correctly reported `VulnerableSmartAccount`. Platform deduplication could not function without contract attribution.

2. **AA detector false positives on non-wallet contracts** — AA classification gates (`is_erc4337_wallet()`, `is_aa_account()`, etc.) used overly broad keyword matching (e.g., matching on "EntryPoint" or "validateUserOp" alone). This caused `MaliciousEntryPoint` (an attack contract, not a wallet) to receive 4 AA findings.

### Platform Comparison: VulnerableEntryPointTrust.sol

| Metric | Platform DB (Before) | CLI v12 (After) | Change |
|--------|---------------------|-----------------|--------|
| Total findings | 70 | 21 | -49 (-70%) |
| Findings with contract_name | 2 (slither only) | 21 (all) | +19 |
| MaliciousEntryPoint findings | 4 AA | 0 | -4 |
| VulnerableSmartAccount | ~20 (mixed, no attribution) | 13 | Correctly scoped |
| SecureSmartAccount | ~15 (mixed, no attribution) | 8 | Correctly scoped |
| IEntryPoint interface | Findings at line 21 | 0 | Correctly skipped |

### Findings by Contract (After v12)

**VulnerableSmartAccount** (13 findings — all legitimate):
| Detector | Line | Severity |
|----------|------|----------|
| aa-user-operation-replay | 1 | High |
| aa-entry-point-reentrancy | 1 | Medium |
| aa-bundler-dos-enhanced | 1 | High |
| enhanced-input-validation | 1 | Medium |
| contract-recreation-attack | 11 | Critical |
| bundle-inclusion-leak | 39 | High |
| nonce-reuse | 64 | Medium |
| aa-account-takeover | 64 | Critical |
| aa-nonce-management | 64 | High |
| erc4337-gas-griefing | 64 | Low |
| parameter-consistency | 84 | Low |
| erc4337-entrypoint-trust | 100 | Critical |
| aa-account-takeover | 103 | Critical |

**MaliciousEntryPoint** (0 findings — correctly excluded by classification fix)

**SecureSmartAccount** (8 findings — detector precision issue, not cross-contract bleeding):
| Detector | Line | Severity | Notes |
|----------|------|----------|-------|
| bundle-inclusion-leak | 11, 61 | High | Pre-contract lines, platform can filter by contract_name |
| nonce-reuse | 185 | Medium | Has onlyEntryPoint but detector doesn't recognize |
| aa-account-takeover | 185, 210 | Critical | Has access control, detector FP |
| aa-nonce-management | 185 | High | Has onlyEntryPoint modifier |
| erc4337-gas-griefing | 185 | Low | Has access control |
| parameter-consistency | 202 | Low | Style finding |

### Key Technical Changes

1. **`contract_name` field added to Finding struct** (`types.rs`):
   - New field: `contract_name: Option<String>`
   - Populated from `ctx.contract.name` in `BaseDetector::create_finding()`
   - Propagated to `JsonFinding` in JSON output (`json.rs`)
   - Enables platform-level deduplication and contract-scoped display

2. **AA classification gates tightened** (4 files):
   - `erc4337_entrypoint_trust.rs` — `is_erc4337_wallet()`: now requires `validateUserOp` AND wallet structure (owner/nonce/EntryPoint storage), not just keyword presence
   - `aa_account_takeover.rs` — `is_erc4337_contract()`: same tightening
   - `aa/classification.rs` — `is_aa_account()`: requires `IAccount` OR (`validateUserOp` AND wallet structure)
   - `aa_nonce_management.rs` — `is_nonce_management_contract()`: requires wallet structure before checking nonce patterns

3. **Line-range filter** (`registry.rs`):
   - Filters findings past `contract_end` line to prevent cross-contract bleeding
   - Preserves file-level findings (line 1-2) for first contract

### Files Modified

| File | Change |
|------|--------|
| `crates/detectors/src/types.rs` | Added `contract_name: Option<String>` to Finding |
| `crates/detectors/src/detector.rs` | Populate contract_name in create_finding() |
| `crates/output/src/json.rs` | Added contract_name to JsonFinding, map in convert_finding() |
| `crates/detectors/src/erc4337_entrypoint_trust.rs` | Tightened is_erc4337_wallet() |
| `crates/detectors/src/aa_account_takeover.rs` | Tightened is_erc4337_contract() |
| `crates/detectors/src/aa/classification.rs` | Tightened is_aa_account() |
| `crates/detectors/src/aa_nonce_management.rs` | Tightened is_nonce_management_contract() |
| `crates/detectors/src/registry.rs` | Line-range filter (contract_end only) |
| `crates/output/src/console.rs` | Test fix (contract_name field) |

### Verification

| Metric | v11 (Before) | v12 (After) | Change |
|--------|--------------|-------------|--------|
| Total Findings (18 targets) | 1,089 | 1,089 | 0 |
| Clean FPs | 3 | 3 | 0 |
| Parse Errors | 0 | 0 | 0 |
| Recall (TPs) | 78/78 | 78/78 | 100% |
| Tests Passing | 1,595 | 1,595 | 0 |
| VulnerableEntryPointTrust | 25 (no contract_name) | 21 (all with contract_name) | -4 |

### Full v1.10.20 FP Reduction History (v1-v12)

| Metric | v1.10.19 (Start) | v10 | v11 | v12 (Current) | Total Change |
|--------|-------------------|-----|-----|---------------|--------------|
| Total Findings | 1,776 | 1,089 | 1,089 | 1,089 | -687 (38.7%) |
| Clean FPs | 26 | 3 | 3 | 3 | -23 (88.5%) |
| Parse Errors | 3 | 0 | 0 | 0 | -3 (100%) |
| Recall (TPs) | -- | 78/78 | 78/78 | 78/78 | 100% |
| VulnerableEntryPointTrust | 70 (platform) | -- | 25 | 21 | -49 (-70%) |
| Contract Attribution | No | No | No | Yes | New feature |
