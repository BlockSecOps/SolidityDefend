#!/usr/bin/env python3
"""
SolidityDefend Test Results Analyzer
Analyzes JSON test results and generates comprehensive reports
"""

import json
import sys
from pathlib import Path
from collections import defaultdict
from datetime import datetime

def load_result(file_path):
    """Load a JSON result file"""
    with open(file_path) as f:
        return json.load(f)

def analyze_contract_results(results_dir):
    """Analyze all results in a directory"""
    results_dir = Path(results_dir)

    all_results = {}
    total_findings = 0
    total_contracts = 0
    severity_counts = defaultdict(int)
    detector_counts = defaultdict(int)

    # Load all results
    for result_file in results_dir.glob("*.json"):
        contract_name = result_file.stem
        try:
            data = load_result(result_file)
            all_results[contract_name] = data
            total_contracts += 1

            findings = data.get('findings', [])
            total_findings += len(findings)

            # Count by severity
            for finding in findings:
                severity = finding.get('severity', 'unknown')
                severity_counts[severity] += 1

                detector_id = finding.get('detector_id', 'unknown')
                detector_counts[detector_id] += 1

        except Exception as e:
            print(f"Error loading {result_file}: {e}", file=sys.stderr)

    return {
        'results': all_results,
        'total_contracts': total_contracts,
        'total_findings': total_findings,
        'severity_counts': dict(severity_counts),
        'detector_counts': dict(detector_counts)
    }

def generate_markdown_report(analysis, output_file):
    """Generate a markdown report"""

    report = f"""# SolidityDefend Test Results Report

**Date**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**Test Phase**: Phase 1 - Simple Contracts
**SolidityDefend Version**: v1.3.6

---

## Executive Summary

| Metric | Value |
|--------|-------|
| Contracts Tested | {analysis['total_contracts']} |
| Total Findings | {analysis['total_findings']} |
| Average Findings per Contract | {analysis['total_findings'] / analysis['total_contracts']:.1f} |

---

## Severity Distribution

| Severity | Count | Percentage |
|----------|-------|------------|
"""

    total = analysis['total_findings']
    severity_order = ['critical', 'high', 'medium', 'low', 'info']
    for sev in severity_order:
        count = analysis['severity_counts'].get(sev, 0)
        pct = (count / total * 100) if total > 0 else 0
        report += f"| {sev.capitalize()} | {count} | {pct:.1f}% |\n"

    report += f"| **Total** | **{total}** | **100%** |\n\n"

    report += """---

## Top Detectors Triggered

| Detector ID | Occurrences | Description |
|-------------|-------------|-------------|
"""

    # Sort detectors by count
    sorted_detectors = sorted(analysis['detector_counts'].items(), key=lambda x: x[1], reverse=True)
    for detector_id, count in sorted_detectors[:15]:
        report += f"| {detector_id} | {count} | - |\n"

    report += """
---

## Individual Contract Results

"""

    for contract_name, data in sorted(analysis['results'].items()):
        findings = data.get('findings', [])
        critical = sum(1 for f in findings if f.get('severity') == 'critical')
        high = sum(1 for f in findings if f.get('severity') == 'high')
        medium = sum(1 for f in findings if f.get('severity') == 'medium')
        low = sum(1 for f in findings if f.get('severity') == 'low')

        report += f"""### {contract_name}.sol

- **Total Findings**: {len(findings)}
- **Critical**: {critical}
- **High**: {high}
- **Medium**: {medium}
- **Low**: {low}

**Key Findings**:
"""

        # List top 5 critical/high findings
        critical_high = [f for f in findings if f.get('severity') in ['critical', 'high']][:5]
        for f in critical_high:
            detector = f.get('detector_id', 'unknown')
            line = f.get('location', {}).get('line', 'N/A')
            msg = f.get('message', 'No description')[:80]
            report += f"- [{f.get('severity', '?').upper()}] Line {line}: `{detector}` - {msg}\n"

        report += "\n"

    report += """---

## Analysis Complete

This report was automatically generated by the SolidityDefend test analyzer.

**Next Steps**:
1. Review critical and high severity findings
2. Verify expected vulnerabilities were detected
3. Check for false positives
4. Document any missed vulnerabilities

---

**Generated by**: SolidityDefend Test Suite
**Report Version**: 1.0.0
"""

    with open(output_file, 'w') as f:
        f.write(report)

    print(f"Report generated: {output_file}")

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: python analyze_results.py <results_directory> [output_file]")
        sys.exit(1)

    results_dir = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else 'test-report.md'

    print(f"Analyzing results from: {results_dir}")
    analysis = analyze_contract_results(results_dir)

    print(f"\nSummary:")
    print(f"  Contracts: {analysis['total_contracts']}")
    print(f"  Findings: {analysis['total_findings']}")
    print(f"  Average: {analysis['total_findings'] / analysis['total_contracts']:.1f} per contract")

    generate_markdown_report(analysis, output_file)
